var j=Object.defineProperty;var C=r=>{throw TypeError(r)};var A=(r,e,t)=>e in r?j(r,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):r[e]=t;var d=(r,e,t)=>A(r,typeof e!="symbol"?e+"":e,t),z=(r,e,t)=>e.has(r)||C("Cannot "+t);var l=(r,e,t)=>(z(r,e,"read from private field"),t?t.call(r):e.get(r)),h=(r,e,t)=>e.has(r)?C("Cannot add the same private member more than once"):e instanceof WeakSet?e.add(r):e.set(r,t);import{aS as f,al as m,l as u,a5 as g,a9 as N}from"./Dzf0_vqf.js";import{g as O,p as F}from"./OLwK5Wgf.js";import"./Bzak7iHL.js";import"./VRJz6rhc.js";let B=class{constructor(e,t){d(this,"id");d(this,"socket");this.id=e,this.socket=t}addMessageHandler(e,t){this.socket.addMessageHandler(this.id,e,t)}sendMessage(e,t){this.socket.sendMessage({pluginID:this.id,messageID:e,data:t})}removeMessageHandler(e,t){this.socket.removeMessageHandler(this.id,e)}};async function q(r){const e=new Blob([r],{type:"text/javascript"}),t=URL.createObjectURL(e),n=await import(t);return URL.revokeObjectURL(t),n}class W{constructor(){d(this,"socket",null);d(this,"messageHandlers",{});d(this,"pluginManagers",{});d(this,"log",[]);d(this,"maxLogSize",100);d(this,"maxQueueSize",256);d(this,"outgoingQueue",[]);d(this,"isDraining",!1)}async initPlugins(e,t){const n={};await Promise.all(e.map(async s=>{var a;try{const i=((a=s.details.manager.textContent)==null?void 0:a.trim())??"";if(!i){console.warn(`[plugin:${s.details.id}] Missing manager source`);return}const o=await q(i),c=o==null?void 0:o.default;if(typeof c!="function"){console.error(`[plugin:${s.details.id}] Manager default export not found`);return}const p=new c(new B(s.details.id,this),s.details,t);n[s.details.id]=p,typeof p.onInit=="function"&&await p.onInit()}catch(i){console.error(`[plugin:${s.details.id}] Failed to initialize`,i)}})),this.pluginManagers={...this.pluginManagers,...n}}async initSocket(e){this.log=[];const t=window.location.hostname,s=`${window.location.protocol==="https:"?"wss":"ws"}://${t}:8002`,a=new WebSocket(s);this.socket=a,await new Promise((i,o)=>{const c=()=>{console.log("WebSocket connection opened:",s),V(),i()},p=L=>{console.error("WebSocket error:",L),V(),e(),o(L)},V=()=>{a.removeEventListener("open",c),a.removeEventListener("error",p)};a.addEventListener("open",c),a.addEventListener("error",p)}),a.addEventListener("open",()=>{this.drainQueue()}),this.drainQueue(),a.addEventListener("message",i=>{this.log=[...this.log,i.data].slice(-this.maxLogSize);try{const o=JSON.parse(i.data);console.log(o.pluginID,o.messageID,o.data),this.handleMessage(o.pluginID,o.messageID,o.data)}catch(o){console.error("Failed to parse message:",o,i.data)}}),a.addEventListener("error",i=>{console.error("WebSocket error:",i),e()}),a.addEventListener("close",()=>{console.log("WebSocket connection closed"),e()})}close(){var e;(e=this.socket)==null||e.close()}handleMessage(e,t,n){const s=this.messageHandlers[`${e}-${t}`];s?s(n):console.warn(`No handler for message kind: ${e}-${t}`)}addMessageHandler(e,t,n){this.messageHandlers[`${e}-${t}`]=n}sendMessage(e){const t=JSON.stringify(e);this.outgoingQueue.length>=this.maxQueueSize&&(console.warn("Outgoing queue full. Dropping oldest message."),this.outgoingQueue.shift()),this.outgoingQueue.push(t),this.drainQueue()}clearQueue(){this.outgoingQueue.length=0}drainQueue(){if(!this.isDraining&&!(!this.socket||this.socket.readyState!==WebSocket.OPEN)){this.isDraining=!0;try{for(;this.socket&&this.socket.readyState===WebSocket.OPEN&&this.outgoingQueue.length>0;){const e=this.outgoingQueue.shift();try{this.socket.send(e)}catch(t){this.outgoingQueue.unshift(e),console.error("Send failed; will retry later.",t);break}}}finally{this.isDraining=!1}}}removeMessageHandler(e,t){delete this.messageHandlers[`${e}-${t}`]}}class H{constructor(){d(this,"data",[]);d(this,"callbacks",[])}onUpdate(e){this.callbacks.push(e)}sendUpdate(){for(const e of this.callbacks)e(this.data)}add(e){this.data.push({id:O(),timestamp:Date.now(),text:e,executedAction:!1,actions:[]}),this.sendUpdate()}addAction(e,t){const n=O();this.data.push({id:n,timestamp:Date.now(),text:e,executedAction:!1,actions:t.map(s=>({text:s.text,task:()=>{s.task();for(const a of this.data)a.id==n&&(a.executedAction=!0,this.sendUpdate())}}))}),this.sendUpdate()}}async function _(r){const e=new Blob([r],{type:"text/javascript"}),t=URL.createObjectURL(e),n=await import(t);return URL.revokeObjectURL(t),n}class J{constructor(e,t){d(this,"id");d(this,"socket");this.id=e,this.socket=t}addMessageHandler(e,t){this.socket.addMessageHandler(this.id,e,t)}sendMessage(e,t){this.socket.sendMessage({pluginID:this.id,messageID:e,data:t})}removeMessageHandler(e,t){this.socket.removeMessageHandler(this.id,e)}}const G="PanelsDB",w="PluginData",K=1;async function U(){return new Promise((r,e)=>{const t=indexedDB.open(G,K);t.onupgradeneeded=()=>{const n=t.result;n.objectStoreNames.contains(w)||n.createObjectStore(w)},t.onsuccess=()=>r(t.result),t.onerror=()=>e(t.error)})}async function v(r,e){const t=await U();return new Promise((n,s)=>{const o=t.transaction(w,"readwrite").objectStore(w).put(e,r);o.onsuccess=()=>n(!0),o.onerror=()=>s(o.error)})}async function E(r){const e=await U();return new Promise((t,n)=>{const i=e.transaction(w,"readonly").objectStore(w).get(r);i.onsuccess=()=>t(i.result??null),i.onerror=()=>n(i.error)})}async function Q(r){const e=await U();return new Promise((t,n)=>{const i=e.transaction(w,"readwrite").objectStore(w).delete(r);i.onsuccess=()=>t(!0),i.onerror=()=>n(i.error)})}function X(r){const e=F.inflate(r);return new TextDecoder("utf-8").decode(e)}var k,y,b,S,D,P,x,M,T,$,I,R;class Y{constructor(){h(this,k,f(m([])));h(this,y,f(m([])));d(this,"notificationsManager",new H);h(this,b,N(()=>{let e=[];for(const t of this.plugins)for(const n of t.details.templates){const s=new Set([]),a=new Set(this.plugins.map(o=>o.details.id));for(const o of n.widgets)for(const c of o.widgets)s.add(c.pluginID);for(const o of n.navlets)s.add(o.pluginID);const i=Array.from(s).filter(o=>!a.has(o));e.push({...n,pluginID:t.details.id,missingPlugins:i})}return e}));h(this,S,f(m([])));d(this,"socket",new W);h(this,D,f(!1));d(this,"updateInterval",null);d(this,"interval",null);h(this,P,f(m({})));h(this,x,f(m({})));h(this,M,f(m({})));h(this,T,f(m({})));h(this,$,N(()=>{if(!this.isConnected)return!1;for(const e of this.plugins)for(const t of e.details.templates)if(!this.pluginsTemplatesPreviews[`${e.details.id}/${t.name}`])return!1;return!0}));h(this,I,f(m([])));h(this,R,f(!1));d(this,"panelsVersion","0.0.21")}get plugins(){return u(l(this,k))}set plugins(e){g(l(this,k),e,!0)}get notifications(){return u(l(this,y))}set notifications(e){g(l(this,y),e,!0)}get allTemplates(){return u(l(this,b))}set allTemplates(e){g(l(this,b),e)}get skippedPlugins(){return u(l(this,S))}set skippedPlugins(e){g(l(this,S),e,!0)}get isConnected(){return u(l(this,D))}set isConnected(e){g(l(this,D),e,!0)}async getFromServer(e,t){const n=`${e.replace(/\/+$/,"")}/${t.replace(/^\/+/,"")}`,s=1e3,a=200,i=Math.ceil(s/a);let o=0;for(;o<i;)try{const c=await fetch(n);if(!c.ok)throw new Error(`Failed to fetch: ${c.status} ${c.statusText}`);return await c.text()}catch(c){if(o++,o>=i)throw console.error(`Failed after ${o} attempts:`,c),c;await new Promise(p=>setTimeout(p,a))}throw new Error(`Unexpected error while fetching ${n}`)}get reloadIndexes(){return u(l(this,P))}set reloadIndexes(e){g(l(this,P),e,!0)}get lastVersionNotificationTime(){return u(l(this,x))}set lastVersionNotificationTime(e){g(l(this,x),e,!0)}get changedTimestamps(){return u(l(this,M))}set changedTimestamps(e){g(l(this,M),e,!0)}get pluginsTemplatesPreviews(){return u(l(this,T))}set pluginsTemplatesPreviews(e){g(l(this,T),e,!0)}get isPrepared(){return u(l(this,$))}set isPrepared(e){g(l(this,$),e)}get devPlugins(){return u(l(this,I))}set devPlugins(e){g(l(this,I),e,!0)}get hasDevServer(){return u(l(this,R))}set hasDevServer(e){g(l(this,R),e,!0)}createDevServerInterval(){this.interval!==null&&clearInterval(this.interval),this.interval=setInterval(async()=>{await this.updateDevPlugins(!0)},this.hasDevServer?1500:1e4)}async updateDevPlugins(e=!1){var n;let t;try{t=await(await this.fetchWithRetry("http://localhost:3001/plugins",{},1)).json(),this.hasDevServer||this.createDevServerInterval(),this.hasDevServer=!0}catch(s){console.error("Failed to fetch live plugins:",s),this.hasDevServer&&this.createDevServerInterval(),this.hasDevServer=!1;return}for(const s of t)if(this.devPlugins.includes(s.id)||this.devPlugins.push(s.id),s.lastChanged!=this.changedTimestamps[s.id]){console.log("Rebuilding",s.name);let i=await(await this.fetchWithRetry(`http://localhost:3001/plugins/${s.id}`,{},1)).json();if(e){const{default:o}=await _(i.manager.textContent||""),c=this.socket.pluginManagers[i.id].state.data;this.socket.pluginManagers[i.id]=new o(new J(i.id,this.socket),i,this.notificationsManager),this.socket.pluginManagers[i.id].state.data=c;for(const p of Object.values(this.socket.pluginManagers[i.id].state.data))for(const V of p.callbacks)V(p.value);(n=this.socket.pluginManagers[i.id])==null||n.onInit()}for(const o of i.templates){const c=`${s.id}/${o.name}`;delete this.pluginsTemplatesPreviews[c]}for(const o of this.plugins)o.details.id==s.id&&(o.details=i);this.reloadIndexes[i.id]++,console.log("Reloaded plugin",s.id),this.changedTimestamps[s.id]=s.lastChanged}}async hasInternetConnection(){try{return(await fetch("https://raw.githubusercontent.com/lazarcloud/ftcontrol-maven/refs/heads/main/dev/com/bylazar/panels/maven-metadata.xml",{cache:"no-cache"})).ok}catch{return!1}}async init(){const e=Date.now();console.log("[init] Starting initialization...");try{this.plugins=[],this.hasDevServer=!1,this.notifications=[],this.notificationsManager=new H,this.skippedPlugins=[],this.socket=new W,this.notificationsManager.callbacks=[],this.notificationsManager.onUpdate(i=>{this.notifications=i}),this.notifications=this.notificationsManager.data,this.isConnected=!1;const t=Date.now(),n=await this.getPluginsUntilReady();console.log(`[init] getPluginsUntilReady() took ${Date.now()-t}ms`);const s=JSON.parse(n);this.plugins=s.data.plugins,console.log(`[init] Loaded ${this.plugins.length} plugins`),this.plugins.forEach(i=>{this.reloadIndexes[i.details.id]=0,this.changedTimestamps[i.details.id]=0,this.lastVersionNotificationTime[i.details.id]=0}),this.skippedPlugins=s.data.skippedPlugins,console.log(`[init] Skipped ${this.skippedPlugins.length} plugins`);const a=Date.now();this.interval!==null&&clearInterval(this.interval),await this.socket.initPlugins(this.plugins,this.notificationsManager),await this.updateDevPlugins(!0),this.createDevServerInterval(),console.log("[init] Dev plugin interval set up"),await this.socket.initSocket(async()=>{window.location.reload()}),console.log(`[init] socket.init() took ${Date.now()-a}ms`),this.isConnected=!0,this.updateInterval!==null&&clearInterval(this.updateInterval),this.updateInterval=setInterval(async()=>{await this.hasInternetConnection()&&(console.log("Has internet"),await this.checkVersions())},1e4),console.log(`[init] Initialization complete in ${Date.now()-e}ms`),this.plugins.map(i=>i.details.id).includes("com.pedropathing.panels.exampleplugin")&&this.notificationsManager.addAction("Don't use default plugin id",[{text:"OK",task:()=>{}},{text:"Details",task:()=>{}}])}catch(t){console.error("[init] Error during initialization:",t),window.location.reload()}}close(){this.isConnected=!1,this.interval&&clearInterval(this.interval),this.socket.close()}async getPluginsUntilReady(){var e=await this.getSha(),t=await E("sha256"),n=await E("plugins"),s=await E("version");if(s!==this.panelsVersion)throw await Q("sha256"),await Q("plugins"),await v("version",this.panelsVersion),Error("Panels version changed");if(e==t&&n)return setTimeout(async()=>{const i=await this.getPlugins();i!=null&&i!=n&&(await v("sha256",e),await v("plugins",i),await v("version",this.panelsVersion),window.location.reload())},100),n;await v("sha256",e);const a=await this.getPlugins();return await v("plugins",a),await v("version",this.panelsVersion),a}fetchWithTimeout(e,t={},n=5e3){const s=new AbortController,a=setTimeout(()=>s.abort(),n);return fetch(e,{...t,signal:s.signal}).finally(()=>clearTimeout(a))}fetchWithRetry(e,t={},n=3,s=1e3,a=250){return this.fetchWithTimeout(e,t,s).catch(i=>{if(n>0)return console.warn(`Retrying... (${n} left), Error: ${i.message}`),new Promise(o=>setTimeout(o,a)).then(()=>this.fetchWithRetry(e,t,n-1,s,a*2));throw i})}async getSha(e=0){if(e>5)throw Error("Tried too many times.");const t=window.location.origin;try{const s=await(await this.fetchWithRetry(`${t}/api/sha256`,{})).text();return s&&s.trim()!="null"?s:this.getSha(e+1)}catch(n){throw console.warn("Fetch failed, retrying...",n),n}}async getPlugins(){const e=window.location.origin,n=await(await this.fetchWithRetry(`${e}/api/plugins`,{},5,4e3,500)).arrayBuffer(),s=new Uint8Array(n),a=performance.now(),i=X(s),o=performance.now();return console.log(`Decompression took ${(o-a).toFixed(2)} ms`),i}async getLatestVersion(){var e;try{const t=await fetch("https://raw.githubusercontent.com/lazarcloud/ftcontrol-maven/refs/heads/main/dev/com/bylazar/panels/maven-metadata.xml");if(!t.ok)throw new Error(`HTTP ${t.status}`);const n=await t.text();return((e=new DOMParser().parseFromString(n,"application/xml").querySelector("latest"))==null?void 0:e.textContent)||""}catch{return""}}async checkVersions(){const e=["com.pedropathing.panels.battery","com.pedropathing.panels.capture","com.pedropathing.panels.configurables","com.pedropathing.panels.docs","com.pedropathing.panels.field","com.pedropathing.panels.gamepad","com.pedropathing.panels.limelightproxy","com.pedropathing.panels.opmodecontrol","com.pedropathing.panels.telemetry","com.pedropathing.panels.themes","com.pedropathing.panels.utils","com.pedropathing.panels.pinger"];let t=!1;for(const s of this.plugins)s.details.id=="com.pedropathing.panels.fullpanels"&&(t=!0);console.log("isCombined",t);for(const s of this.plugins){const a=s.details.id,i=this.lastVersionNotificationTime[a]??0;if(Date.now()-i<900*1e3||t&&e.includes(a))continue;const o=this.socket.pluginManagers[a];console.log("Checking plugin version",a,o.config.version);const c=await o.getNewVersion();var n=c!=o.config.version;c==""&&(n=!1),c!=""&&(this.lastVersionNotificationTime[a]=Date.now()),n?this.notificationsManager.addAction(`Plugin ${a} has a new version: ${c}`,[{text:"Check Website",task:()=>{window.open(s.details.websiteURL,"_blank")}},{text:"Remind me later",task:()=>{}}]):console.log(`Plugin ${a} is latest`)}if(!t){const s=this.lastVersionNotificationTime.panels??0;if(Date.now()-s<900*1e3)return;const a=await this.getLatestVersion();a!=""&&(this.lastVersionNotificationTime.panels=Date.now()),a!=this.panelsVersion&&a!=""?this.notificationsManager.addAction(`Panels has a new version: ${a}`,[{text:"Check Website",task:()=>{window.open("https://panels.bylazar.com","_blank")}},{text:"Remind me later",task:()=>{}}]):console.log("Panels is latest")}}}k=new WeakMap,y=new WeakMap,b=new WeakMap,S=new WeakMap,D=new WeakMap,P=new WeakMap,x=new WeakMap,M=new WeakMap,T=new WeakMap,$=new WeakMap,I=new WeakMap,R=new WeakMap;const ae=new Y;export{ae as g,q as i};
